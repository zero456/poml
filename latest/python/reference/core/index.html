
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/poml/latest/python/reference/core/">
      
      
        <link rel="prev" href="../../integration/weave/">
      
      
        <link rel="next" href="../integration/">
      
      
      <link rel="icon" href="../../../media/logo-16-purple.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Core - POML Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/timeago.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="poml" data-md-color-accent="poml">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python-poml-core-apis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="POML Documentation" class="md-header__button md-logo" aria-label="POML Documentation" data-md-component="logo">
      
  <img src="../../../media/logo-64-white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            POML Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Core
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="poml" data-md-color-accent="poml"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="poml" data-md-color-accent="poml"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/poml" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/poml
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="POML Documentation" class="md-nav__button md-logo" aria-label="POML Documentation" data-md-component="logo">
      
  <img src="../../../media/logo-64-white.png" alt="logo">

    </a>
    POML Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/poml" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/poml
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Travel Expense Agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Travel Expense Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/expense_part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part 1 - Build Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/expense_part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Part 2 - Debug with VS Code Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Language Spec
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Language Spec
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Syntax
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Template Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/meta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Meta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fine-grained Control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Fine-grained Control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/white-space/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    White Space Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/token/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Token Control
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../language/components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Visual Studio Code
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Visual Studio Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../vscode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../vscode/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../vscode/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tracing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Integrations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Integrations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangChain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/mlflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MLflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/agentops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AgentOps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/weave/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Weave
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" checked>
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#poml" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;poml
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" poml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#poml.clear_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;clear_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.get_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.poml" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;poml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.set_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;set_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.trace_artifact" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;trace_artifact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    TypeScript
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            TypeScript
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/essentials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    essentials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/file/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    file
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/writer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    writer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../typescript/reference/components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deep Dive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Deep Dive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deep-dive/ir/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IR Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Proposals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Proposals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../deep-dive/proposals/poml_extended/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended POML
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Miscellaneous
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#poml" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;poml
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" poml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#poml.clear_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;clear_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.get_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.poml" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;poml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.set_trace" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;set_trace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poml.trace_artifact" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;trace_artifact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <div id="version-warning" class="version-warning" style="display: none;">
    ⚠️ You are viewing development documentation. For stable documentation, please visit 
    <a href="https://microsoft.github.io/poml/stable/">https://microsoft.github.io/poml/stable/</a>
  </div>
  
                  


  
  


<h1 id="python-poml-core-apis">Python POML Core APIs<a class="headerlink" href="#python-poml-core-apis" title="Permanent link">&para;</a></h1><p style="color:#bdbdbd"><i>Estimated time to read: 1 minute</i></p>



<div class="doc doc-object doc-module">



<h2 id="poml" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>poml</code>


<a href="#poml" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="poml.clear_trace" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">clear_trace</span><span class="p">()</span></code>

<a href="#poml.clear_trace" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Clear the collected trace log.</p>


            <details class="quote">
              <summary>Source code in <code>python/poml/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_trace</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the collected trace log.&quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">_trace_log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="poml.get_trace" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">get_trace</span><span class="p">()</span></code>

<a href="#poml.get_trace" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return a copy of the trace log.</p>


            <details class="quote">
              <summary>Source code in <code>python/poml/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_trace</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of the trace log.&quot;&quot;&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_trace_log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="poml.poml" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">poml</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stylesheet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;message_dict&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#poml.poml" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process POML markup and return the result in the specified format.</p>
<p>POML (Prompt Orchestration Markup Language) is a markup language for creating
structured prompts and conversations. This function processes POML markup
with optional context and styling, returning the result in various formats
optimized for different LLM frameworks and use cases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>markup</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>POML markup content as a string, or path to a POML file.
If a string that looks like a file path but doesn't exist,
a warning is issued and it's treated as markup content.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | <span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional context data to inject into the POML template.
Can be a dictionary, JSON string, or path to a JSON file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stylesheet</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | <span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional stylesheet for customizing POML rendering.
Can be a dictionary, JSON string, or path to a JSON file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chat</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, process as a chat conversation (default).
If False, process as a single prompt.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to save the output. If not provided,
output is returned directly without saving to disk.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>format</code>
            </td>
            <td>
                  <code><span title="poml.api.OutputFormat">OutputFormat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output format for the result:
- "raw": Raw string output from POML processor
- "message_dict": Legacy format returning just messages array (default)
- "dict": Full CLI result structure with messages, schema, tools, runtime
- "openai_chat": OpenAI Chat Completion API format with tool support
- "langchain": LangChain message format with structured data
- "pydantic": PomlFrame object with typed Pydantic models</p>
              </div>
            </td>
            <td>
                  <code>&#39;message_dict&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encoding</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional file encoding for both reading input POML file and
writing output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extra_args</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional command-line arguments to pass to the POML processor.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The processed result in the specified format:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>str when format="raw"</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>list when format="message_dict" (legacy messages array)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>dict when format="dict", "openai_chat", or "langchain"</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>PomlFrame when format="pydantic"</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For format="message_dict": Returns just the messages array for backward</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>compatibility. Example: <code>[{"speaker": "human", "content": "Hello"}]</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For format="dict": Returns complete structure with all metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Example</code></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>{"messages": [...], "schema": {...}, "tools": [...], "runtime": {...}}</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For format="openai_chat": Returns OpenAI Chat Completion format with tool/schema</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>support. Includes "messages" in OpenAI format, "tools" if present, "response_format"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>for JSON schema if present, and runtime parameters converted to <code>snake_case</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For format="langchain": Returns LangChain format preserving all metadata with</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>"messages" in LangChain format plus schema, tools, and runtime if present.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For format="pydantic": Returns strongly-typed PomlFrame object containing</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="list">list</span> | <span title="dict">dict</span> | <span title="str">str</span> | <span title="poml.api.PomlFrame">PomlFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>messages as PomlMessage objects, output_schema, tools, and runtime.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When a specified file path doesn't exist.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When the POML processor fails or backend tracing requirements aren't met.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When an invalid output format is specified.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic usage with markup string:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">poml</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Hello {{name}}!&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;World&quot;</span><span class="p">})</span>
</code></pre></div>
    <p>Load from file with context:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">poml</span><span class="p">(</span><span class="s2">&quot;template.poml&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;context.json&quot;</span><span class="p">)</span>
</code></pre></div>
    <p>Get OpenAI chat format:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">messages</span> <span class="o">=</span> <span class="n">poml</span><span class="p">(</span><span class="s2">&quot;chat.poml&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;openai_chat&quot;</span><span class="p">)</span>
</code></pre></div>
    <p>Use with custom stylesheet:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">poml</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">markup</span><span class="o">=</span><span class="s2">&quot;template.poml&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">stylesheet</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;captionStyle&quot;</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">}},</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">... </span>    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pydantic&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div>
    <p>Save output to file:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">poml</span><span class="p">(</span><span class="s2">&quot;template.poml&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;output.json&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">)</span>
</code></pre></div>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>When tracing is enabled via set_trace(), call details are automatically logged</li>
<li>The function supports various backend integrations (Weave, AgentOps, MLflow)</li>
<li>Multi-modal content (images, etc.) is supported in chat format</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>python/poml/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="k">def</span><span class="w"> </span><span class="nf">poml</span><span class="p">(</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>    <span class="n">markup</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="n">stylesheet</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="n">chat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="nb">format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="s2">&quot;message_dict&quot;</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">PomlFrame</span><span class="p">:</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process POML markup and return the result in the specified format.</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">    POML (Prompt Orchestration Markup Language) is a markup language for creating</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="sd">    structured prompts and conversations. This function processes POML markup</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">    with optional context and styling, returning the result in various formats</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">    optimized for different LLM frameworks and use cases.</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        markup: POML markup content as a string, or path to a POML file.</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">            If a string that looks like a file path but doesn&#39;t exist,</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">            a warning is issued and it&#39;s treated as markup content.</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        context: Optional context data to inject into the POML template.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">            Can be a dictionary, JSON string, or path to a JSON file.</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">        stylesheet: Optional stylesheet for customizing POML rendering.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">            Can be a dictionary, JSON string, or path to a JSON file.</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        chat: If True, process as a chat conversation (default).</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">            If False, process as a single prompt.</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        output_file: Optional path to save the output. If not provided,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">            output is returned directly without saving to disk.</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        format: Output format for the result:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">            - &quot;raw&quot;: Raw string output from POML processor</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">            - &quot;message_dict&quot;: Legacy format returning just messages array (default)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">            - &quot;dict&quot;: Full CLI result structure with messages, schema, tools, runtime</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">            - &quot;openai_chat&quot;: OpenAI Chat Completion API format with tool support</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">            - &quot;langchain&quot;: LangChain message format with structured data</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">            - &quot;pydantic&quot;: PomlFrame object with typed Pydantic models</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">        encoding: Optional file encoding for both reading input POML file and</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">            writing output file.</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        extra_args: Additional command-line arguments to pass to the POML processor.</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">        The processed result in the specified format:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">        - str when format=&quot;raw&quot;</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">        - list when format=&quot;message_dict&quot; (legacy messages array)</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        - dict when format=&quot;dict&quot;, &quot;openai_chat&quot;, or &quot;langchain&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        - PomlFrame when format=&quot;pydantic&quot;</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        For format=&quot;message_dict&quot;: Returns just the messages array for backward</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        compatibility. Example: `[{&quot;speaker&quot;: &quot;human&quot;, &quot;content&quot;: &quot;Hello&quot;}]`</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        For format=&quot;dict&quot;: Returns complete structure with all metadata.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        Example: `{&quot;messages&quot;: [...], &quot;schema&quot;: {...}, &quot;tools&quot;: [...], &quot;runtime&quot;: {...}}`</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">        For format=&quot;openai_chat&quot;: Returns OpenAI Chat Completion format with tool/schema</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="sd">        support. Includes &quot;messages&quot; in OpenAI format, &quot;tools&quot; if present, &quot;response_format&quot;</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        for JSON schema if present, and runtime parameters converted to `snake_case`.</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">        For format=&quot;langchain&quot;: Returns LangChain format preserving all metadata with</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="sd">        &quot;messages&quot; in LangChain format plus schema, tools, and runtime if present.</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="sd">        For format=&quot;pydantic&quot;: Returns strongly-typed PomlFrame object containing</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a><span class="sd">        messages as PomlMessage objects, output_schema, tools, and runtime.</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="sd">        FileNotFoundError: When a specified file path doesn&#39;t exist.</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">        RuntimeError: When the POML processor fails or backend tracing requirements aren&#39;t met.</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">        ValueError: When an invalid output format is specified.</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        Basic usage with markup string:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">        &gt;&gt;&gt; result = poml(&quot;&lt;p&gt;Hello {{name}}!&lt;/p&gt;&quot;, context={&quot;name&quot;: &quot;World&quot;})</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">        Load from file with context:</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">        &gt;&gt;&gt; result = poml(&quot;template.poml&quot;, context=&quot;context.json&quot;)</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">        Get OpenAI chat format:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">        &gt;&gt;&gt; messages = poml(&quot;chat.poml&quot;, format=&quot;openai_chat&quot;)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">        Use with custom stylesheet:</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">        &gt;&gt;&gt; result = poml(</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">        ...     markup=&quot;template.poml&quot;,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">        ...     context={&quot;user&quot;: &quot;Alice&quot;},</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">        ...     stylesheet={&quot;role&quot;: {&quot;captionStyle&quot;: &quot;bold&quot;}},</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">        ...     format=&quot;pydantic&quot;</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">        Save output to file:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="sd">        &gt;&gt;&gt; poml(&quot;template.poml&quot;, output_file=&quot;output.json&quot;, format=&quot;raw&quot;)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">        - When tracing is enabled via set_trace(), call details are automatically logged</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">        - The function supports various backend integrations (Weave, AgentOps, MLflow)</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">        - Multi-modal content (images, etc.) is supported in chat format</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="n">temp_input_file</span> <span class="o">=</span> <span class="n">temp_context_file</span> <span class="o">=</span> <span class="n">temp_stylesheet_file</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>    <span class="n">trace_record</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="k">if</span> <span class="n">_trace_enabled</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">trace_record</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">)):</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;markup_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                    <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;markup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;markup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="k">elif</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="p">)):</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>                    <span class="n">cpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>                    <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;context_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpath</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>                    <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpath</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="k">elif</span> <span class="n">stylesheet</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">)):</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>                    <span class="n">spath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>                    <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;stylesheet_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spath</span><span class="p">)</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>                    <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spath</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">markup</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">markup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">markup</span><span class="p">):</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                <span class="n">markup</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                <span class="c1"># Test if the markup looks like a path.</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[\w\-./]+$&quot;</span><span class="p">,</span> <span class="n">markup</span><span class="p">):</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                        <span class="sa">f</span><span class="s2">&quot;The markup &#39;</span><span class="si">{</span><span class="n">markup</span><span class="si">}</span><span class="s2">&#39; looks like a file path, but it does not exist. Assuming it is a POML string.&quot;</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>                    <span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>                <span class="n">temp_input_file</span> <span class="o">=</span> <span class="n">write_file</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>                <span class="n">markup</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_input_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_output_file</span><span class="p">:</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>                <span class="n">output_file</span> <span class="o">=</span> <span class="n">temp_output_file</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>                <span class="n">output_file_specified</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="n">output_file_specified</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">),</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">]</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                <span class="n">temp_context_file</span> <span class="o">=</span> <span class="n">write_file</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--context-file&quot;</span><span class="p">,</span> <span class="n">temp_context_file</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>            <span class="k">elif</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>                    <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--context-file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="p">)])</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="n">temp_stylesheet_file</span> <span class="o">=</span> <span class="n">write_file</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--stylesheet-file&quot;</span><span class="p">,</span> <span class="n">temp_stylesheet_file</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>            <span class="k">elif</span> <span class="n">stylesheet</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">):</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--stylesheet-file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stylesheet</span><span class="p">)])</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">stylesheet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="k">if</span> <span class="n">chat</span><span class="p">:</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--chat&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">])</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--chat&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">])</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="k">if</span> <span class="n">_trace_enabled</span> <span class="ow">and</span> <span class="n">_trace_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--traceDir&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">_trace_dir</span><span class="p">)])</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                    <span class="sa">f</span><span class="s2">&quot;POML command failed with return code </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">. See the log for details.&quot;</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>                <span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="k">if</span> <span class="n">output_file_specified</span><span class="p">:</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file_handle</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">output_file_handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">temp_output_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="c1"># Do nothing</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="n">return_result</span> <span class="o">=</span> <span class="n">trace_result</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">trace_result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                <span class="c1"># Handle the new CLI result format with messages, schema, tools, runtime</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">parsed_result</span><span class="p">:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                    <span class="n">cli_result</span> <span class="o">=</span> <span class="n">parsed_result</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                    <span class="n">messages_data</span> <span class="o">=</span> <span class="n">cli_result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                    <span class="c1"># Legacy format - just messages</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                    <span class="n">cli_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">parsed_result</span><span class="p">}</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                    <span class="n">messages_data</span> <span class="o">=</span> <span class="n">parsed_result</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;message_dict&quot;</span><span class="p">:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                    <span class="c1"># Legacy behavior - return just the messages</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                    <span class="n">return_result</span> <span class="o">=</span> <span class="n">messages_data</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                    <span class="c1"># Return the full CLI result structure</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                    <span class="n">return_result</span> <span class="o">=</span> <span class="n">cli_result</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                    <span class="c1"># Convert to pydantic messages for other formats</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                    <span class="k">if</span> <span class="n">chat</span><span class="p">:</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>                        <span class="n">pydantic_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">PomlMessage</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">messages_data</span><span class="p">]</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>                        <span class="c1"># TODO: Make it a RichContent object</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>                        <span class="n">pydantic_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">PomlMessage</span><span class="p">(</span><span class="n">speaker</span><span class="o">=</span><span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">messages_data</span><span class="p">)]</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>                    <span class="c1"># Create PomlFrame with full data</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>                    <span class="n">poml_frame</span> <span class="o">=</span> <span class="n">PomlFrame</span><span class="p">(</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">pydantic_messages</span><span class="p">,</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>                        <span class="n">output_schema</span><span class="o">=</span><span class="n">cli_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">),</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>                        <span class="n">tools</span><span class="o">=</span><span class="n">cli_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">),</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>                        <span class="n">runtime</span><span class="o">=</span><span class="n">cli_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;runtime&quot;</span><span class="p">),</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                    <span class="p">)</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                        <span class="n">return_result</span> <span class="o">=</span> <span class="n">poml_frame</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;openai_chat&quot;</span><span class="p">:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>                        <span class="c1"># Return OpenAI-compatible format</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>                        <span class="n">openai_messages</span> <span class="o">=</span> <span class="n">_poml_response_to_openai_chat</span><span class="p">(</span><span class="n">pydantic_messages</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>                        <span class="n">openai_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">openai_messages</span><span class="p">}</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                        <span class="c1"># Add tools if present</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                        <span class="k">if</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                            <span class="n">openai_result</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>                                <span class="p">{</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>                                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>                                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>                                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>                                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>                                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">{}),</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>                                    <span class="p">},</span>  <span class="c1"># FIXME: hot-fix for the wrong format at node side</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>                                <span class="p">}</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>                                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">tools</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>                            <span class="p">]</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>                        <span class="k">if</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">output_schema</span><span class="p">:</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>                            <span class="n">openai_result</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_schema&quot;</span><span class="p">,</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>                                <span class="s2">&quot;json_schema&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>                                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;schema&quot;</span><span class="p">,</span>  <span class="c1"># TODO: support schema name</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>                                    <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">output_schema</span><span class="p">,</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>                                    <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Ensure strict validation</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>                                <span class="p">},</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>                            <span class="p">}</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                        <span class="k">if</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">runtime</span><span class="p">:</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>                            <span class="n">openai_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>                                <span class="p">{</span><span class="n">_camel_case_to_snake_case</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">poml_frame</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>                            <span class="p">)</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                        <span class="n">return_result</span> <span class="o">=</span> <span class="n">openai_result</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>                    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;langchain&quot;</span><span class="p">:</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                        <span class="n">messages_data</span> <span class="o">=</span> <span class="n">_poml_response_to_langchain</span><span class="p">(</span><span class="n">pydantic_messages</span><span class="p">)</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>                        <span class="n">return_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>                            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages_data</span><span class="p">,</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>                            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cli_result</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;messages&quot;</span><span class="p">},</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>                        <span class="p">}</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown output format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>            <span class="k">if</span> <span class="n">_weave_enabled</span><span class="p">:</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.integration</span><span class="w"> </span><span class="kn">import</span> <span class="n">weave</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>                <span class="n">trace_prefix</span> <span class="o">=</span> <span class="n">_latest_trace_prefix</span><span class="p">()</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>                <span class="n">current_version</span> <span class="o">=</span> <span class="n">_current_trace_version</span><span class="p">()</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>                <span class="k">if</span> <span class="n">trace_prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">current_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Weave tracing requires local tracing to be enabled.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>                <span class="n">poml_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.poml&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.context.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>                <span class="n">stylesheet_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.stylesheet.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>                <span class="n">weave</span><span class="o">.</span><span class="n">log_poml_call</span><span class="p">(</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>                    <span class="n">trace_prefix</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>                    <span class="n">poml_content</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">),</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">context_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">context_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stylesheet_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">stylesheet_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>                    <span class="n">trace_result</span><span class="p">,</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>                <span class="p">)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>            <span class="k">if</span> <span class="n">_agentops_enabled</span><span class="p">:</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.integration</span><span class="w"> </span><span class="kn">import</span> <span class="n">agentops</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>                <span class="n">trace_prefix</span> <span class="o">=</span> <span class="n">_latest_trace_prefix</span><span class="p">()</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>                <span class="n">current_version</span> <span class="o">=</span> <span class="n">_current_trace_version</span><span class="p">()</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>                <span class="k">if</span> <span class="n">trace_prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">current_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgentOps tracing requires local tracing to be enabled.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>                <span class="n">poml_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.poml&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.context.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>                <span class="n">stylesheet_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.stylesheet.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>                <span class="n">agentops</span><span class="o">.</span><span class="n">log_poml_call</span><span class="p">(</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>                    <span class="n">trace_prefix</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>                    <span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">),</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">context_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">context_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stylesheet_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">stylesheet_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>                    <span class="n">trace_result</span><span class="p">,</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>                <span class="p">)</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>            <span class="k">if</span> <span class="n">_mlflow_enabled</span><span class="p">:</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.integration</span><span class="w"> </span><span class="kn">import</span> <span class="n">mlflow</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>                <span class="n">trace_prefix</span> <span class="o">=</span> <span class="n">_latest_trace_prefix</span><span class="p">()</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>                <span class="n">current_version</span> <span class="o">=</span> <span class="n">_current_trace_version</span><span class="p">()</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>                <span class="k">if</span> <span class="n">trace_prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">current_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MLflow tracing requires local tracing to be enabled.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>                <span class="n">poml_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.poml&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.context.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>                <span class="n">stylesheet_content</span> <span class="o">=</span> <span class="n">_read_latest_traced_file</span><span class="p">(</span><span class="s2">&quot;.stylesheet.json&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_poml_call</span><span class="p">(</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>                    <span class="n">trace_prefix</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>                    <span class="n">poml_content</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">markup</span><span class="p">),</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">context_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">context_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stylesheet_content</span><span class="p">)</span> <span class="k">if</span> <span class="n">stylesheet_content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>                    <span class="n">trace_result</span><span class="p">,</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>                <span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>            <span class="k">if</span> <span class="n">trace_record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>                <span class="n">trace_record</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_result</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>            <span class="k">return</span> <span class="n">return_result</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="k">if</span> <span class="n">temp_input_file</span><span class="p">:</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>            <span class="n">temp_input_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="k">if</span> <span class="n">temp_context_file</span><span class="p">:</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>            <span class="n">temp_context_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>        <span class="k">if</span> <span class="n">temp_stylesheet_file</span><span class="p">:</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>            <span class="n">temp_stylesheet_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>        <span class="k">if</span> <span class="n">trace_record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>            <span class="n">_trace_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_record</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="poml.set_trace" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">set_trace</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">trace_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#poml.set_trace" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Enable or disable tracing of <code>poml</code> calls with optional backend integrations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>enabled</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | <span title="typing.List">List</span>[<span title="poml.api.Backend">Backend</span>] | <span title="poml.api.Backend">Backend</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls which tracing backends to enable. Can be:
- True: Enable local tracing only (equivalent to ["local"])
- False: Disable all tracing (equivalent to [])
- str: Enable a single backend ("local", "weave", "agentops", "mlflow")
- List[str]: Enable multiple backends. "local" is auto-enabled if any backends are specified.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_dir</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span> | <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional directory for local trace files. If provided when local
tracing is enabled, a subdirectory named by the current timestamp
(YYYYMMDDHHMMSSffffff) is created inside trace_dir.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the trace directory if local tracing is enabled, None otherwise.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory may be shared with POML Node.js by setting the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>POML_TRACE environment variable in the invoking script.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="available-backends" open>
  <summary>Available backends</summary>
  <ul>
<li>"local": Save trace files to disk</li>
<li>"weave": Log to Weights &amp; Biases Weave (requires local tracing)</li>
<li>"agentops": Log to AgentOps (requires local tracing)</li>
<li>"mlflow": Log to MLflow (requires local tracing)</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>python/poml/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_trace</span><span class="p">(</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Backend</span><span class="p">]</span> <span class="o">|</span> <span class="n">Backend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">trace_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable or disable tracing of ``poml`` calls with optional backend integrations.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        enabled: Controls which tracing backends to enable. Can be:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            - True: Enable local tracing only (equivalent to [&quot;local&quot;])</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            - False: Disable all tracing (equivalent to [])</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            - str: Enable a single backend (&quot;local&quot;, &quot;weave&quot;, &quot;agentops&quot;, &quot;mlflow&quot;)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            - List[str]: Enable multiple backends. &quot;local&quot; is auto-enabled if any backends are specified.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        trace_dir: Optional directory for local trace files. If provided when local</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            tracing is enabled, a subdirectory named by the current timestamp</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            (YYYYMMDDHHMMSSffffff) is created inside trace_dir.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        Path to the trace directory if local tracing is enabled, None otherwise.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        The directory may be shared with POML Node.js by setting the</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        POML_TRACE environment variable in the invoking script.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Available backends:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        - &quot;local&quot;: Save trace files to disk</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        - &quot;weave&quot;: Log to Weights &amp; Biases Weave (requires local tracing)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        - &quot;agentops&quot;: Log to AgentOps (requires local tracing)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        - &quot;mlflow&quot;: Log to MLflow (requires local tracing)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">if</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">enabled</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">elif</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">enabled</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">enabled</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">enabled</span> <span class="o">=</span> <span class="p">[</span><span class="n">enabled</span><span class="p">]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">global</span> <span class="n">_trace_enabled</span><span class="p">,</span> <span class="n">_trace_dir</span><span class="p">,</span> <span class="n">_weave_enabled</span><span class="p">,</span> <span class="n">_agentops_enabled</span><span class="p">,</span> <span class="n">_mlflow_enabled</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">if</span> <span class="n">enabled</span> <span class="ow">or</span> <span class="s2">&quot;local&quot;</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="c1"># When enabled is non-empty, we always enable local tracing.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">_trace_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">env_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;POML_TRACE&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="n">trace_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">trace_dir</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">base</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">run_dir</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="n">ts</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">run_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">_trace_dir</span> <span class="o">=</span> <span class="n">run_dir</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">elif</span> <span class="n">env_dir</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">run_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">env_dir</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">run_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">_trace_dir</span> <span class="o">=</span> <span class="n">run_dir</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">_trace_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">_trace_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">_trace_dir</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">if</span> <span class="s2">&quot;weave&quot;</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">_weave_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">_weave_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">if</span> <span class="s2">&quot;agentops&quot;</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">_agentops_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">_agentops_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">if</span> <span class="s2">&quot;mlflow&quot;</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">_mlflow_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">_mlflow_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">return</span> <span class="n">_trace_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="poml.trace_artifact" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">trace_artifact</span><span class="p">(</span><span class="n">file_suffix</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#poml.trace_artifact" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Write an additional artifact file for the most recent <code>poml</code> call. This API is experimental.</p>


            <details class="quote">
              <summary>Source code in <code>python/poml/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="k">def</span><span class="w"> </span><span class="nf">trace_artifact</span><span class="p">(</span><span class="n">file_suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write an additional artifact file for the most recent ``poml`` call. This API is experimental.&quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">prefix</span> <span class="o">=</span> <span class="n">_latest_trace_prefix</span><span class="p">()</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">suffix</span> <span class="o">=</span> <span class="n">file_suffix</span> <span class="k">if</span> <span class="n">file_suffix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">file_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">else</span> <span class="n">encoding</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="k">return</span> <span class="n">path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="August 23, 2025 16:53:51 UTC"><span class="timeago" datetime="2025-08-23T16:53:51+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 23, 2025 16:53:51 UTC">2025-08-23</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="August 11, 2025 04:35:04 UTC"><span class="timeago" datetime="2025-08-11T04:35:04+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 11, 2025 04:35:04 UTC">2025-08-11</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:yuge.zhang@microsoft.com">Yuge Zhang</a>
    </nav>
  </span>

    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "navigation.instant", "navigation.tracking", "search.suggest", "search.highlight", "content.code.copy", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
  
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../js/timeago.min.js"></script>
      
        <script src="../../../js/timeago_mkdocs_material.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
      
    
  <script>
    // Show warning banner if not viewing stable documentation
    document.addEventListener("DOMContentLoaded", function() {
      const currentURL = window.location.href;
      const warningDiv = document.getElementById("version-warning");
      
      // Check if we're on the stable docs or the redirect page
      if (currentURL.includes('poml/latest/')) {
        // Show warning for explicitly latest docs
        warningDiv.style.display = "block";
      }
    });
  </script>

  </body>
</html>